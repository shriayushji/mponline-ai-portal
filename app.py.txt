from flask import Flask, render_template, request, jsonify
import json
import os
from openai import OpenAI

app = Flask(__name__)

# Load Services
with open("services.json") as f:
    services = json.load(f)

# OpenAI Client
client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))

@app.route("/")
def home():
    return render_template("index.html", services=services)

@app.route("/service/<service_id>")
def service_page(service_id):
    service = services.get(service_id)
    return render_template("service.html", service=service)

@app.route("/chat", methods=["POST"])
def chat():
    user_message = request.json["message"].lower()

    # Intent Matching
    for key, service in services.items():
        for keyword in service["keywords"]:
            if keyword in user_message:
                return jsonify({
                    "reply": f"Here is the complete process for {service['name']}:",
                    "steps": service["steps"],
                    "redirect": f"/service/{key}"
                })

    # GPT Fallback
    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "You are MPOnline AI Assistant helping citizens with services."},
                {"role": "user", "content": user_message}
            ]
        )
        reply = response.choices[0].message.content
        return jsonify({"reply": reply})
    except:
        return jsonify({"reply": "AI is temporarily unavailable."})

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)